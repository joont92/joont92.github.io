---
title: 3장-영속성관리
tags:
---

엔티티 매니저 : 엔티티를 저장하는 가상의 데이터베이스로 볼 수 있다.(엔티티 저장,수정,삭제 등)

```
// 엔티티 매니저를 생성하기 위해선 공장이 필요하다.
EntityManagerFactory emf = Persistence.createEntityManagerFactory("영속성 유닛");
// 엔티티 매니저 생성
EntityManger em = emf.createEntityManger();
```
공장을 만드는 과정은 굉장히 비용이 많이들고, 공장에서 Entity Manager를 생성하는 과정은 비용이 거의 들지 않는다.  
그러므로 EntityMangerFactory는 하나만 만들어서 어플리케이션 전체에서 공유해야 한다.
> 엔티티 매니저 팩토리는 여러 스레드가 동시에 접근해도 안전하지만 엔티티 매니저는 그렇지 않다(동시성 문제). 절대 공유해선 안된다.
![image](https://user-images.githubusercontent.com/18513953/31942438-3a09b74e-b900-11e7-945d-28fac97bc197.png)

위는 JPA를 사용하는 일반적인 웹 어플리케이션의 모습이다.   
대부분의 JPA 구현체는 EntityManagerFactory를 만들 때 커넥션 풀을 생성한다.  
그리고 Entity Manager는 필요한 시점(대부분 트랜잭션을 시작할 때)까지 db 커넥션을 얻지 않는다.  

### 영속성 컨텍스트

엔티티를 영구 저장하는 **논리적인** 환경을 말한다.

엔티티 매니저를 생성하면 영속성 컨텍스트가 만들어지고, 엔티티 매니저를 통해 영속성 컨텍스트에 접근/관리 할 수 있다.

### 엔티티 생명주기

엔티티에는 4가지 상태가 존재한다.

1. 비영속
  간단하게 엔티티 객체를 생성한 상태를 얘기한다.  
  영속성 컨텍스트나 데이터베이스와는 전혀 관련이 없는 상태이다.
  ```java
  User user = new User();
  // ...
  ```

2. 영속
  엔티티 매니저를 통해 엔티티를 영속성 컨텍스트에 저장한(엔티티가 영속성 컨텍스트에 의해 관리되는) 상태이다.
  ```java
  // 아래와 같은 상황들이 영속상태를 만든다
  em.persist(entity);
  em.find(entity_id);
  ```

3. 준영속
  영속성 컨텍스트가 더이상 엔티티를 관리하지 않으면 준영속 상태가 된다.
  ```java
  em.detach(entity);

  em.clear();
  em.close();
  ```

4. 삭제
  엔티티를 영속성 컨텍스트와 데이터베이스에서 삭제한다.
  ```java
  em.remove(entity);
  ```

### 영속성 컨텍스트 특징
- 엔티티는 무조건 식별자 값이 있어야한다.
- 영속성 컨텍스트 -> 데이터베이스는 트랜잭션을 커밋하는 순간에 일어난다. 이를 flush라고 한다.

1. 엔티티 조회
영속성 컨텍스트는 내부 캐시를 가지고 있다. 영속 상태로 관리되는 엔티티는 전부 이 캐시에 저장된다. 
캐시의 형태는 Id와 entity가 key/value로 저장된 map으로 보면 된다.  
find 등을 통해 엔티티를 조회할 때 이 캐시를 먼저 조회하고, 없으면 데이터베이스에서 조회한다.  
persist로 저장한 엔티티, find로 찾은 엔티티(데이터베이스에서 조회해온)가 1차 캐시 저장 대상이다.  
![image](https://user-images.githubusercontent.com/18513953/32005391-274f5db8-b9df-11e7-8cf2-030f5c69461e.png)
간단히 설명하면 위의 그림과 같다.

#### 영속 엔티티의 동일/동등성
- 동일성 : 인스턴스가 같다. ==로 비교함  
- 동등성 : 인스턴스가 가지고 있는 값이 같다. equlas로 비교함 

1차 캐시에서 가져온 엔티티의 경우는 동일성이 성립하는 특징이 있다.   
Map에서 인스턴스를 가져온 것이기 때문에 어찌보면 당연하다!!
```java
User user1 = em.find(User.class, "uid1");
User user2 = em.find(User.class, "uid1");

Assert.assertTrue(user1==user2);
```

### 엔티티 등록
아래는 엔티티 등록 예제이다
```java
EntityManager em = emf.createEntityManager();
EntityTransaction transaction = em.getTransaction();

transaction.begin(); // 트랜잭션 시작 필수

Member member1 = ...;
Member member2 = ...;

em.persist(member1);
em.persist(member2);
// insert를 db에 날리지 않음

transaction.commit(); // flush
```
![image](https://user-images.githubusercontent.com/18513953/32134414-f7cced6c-bc27-11e7-80a9-ddbabcc51c8f.png)  
위는 엔티티등록 과정을 간단히 그림으로 나타낸 것이다.  
보다시피 persist 명령어를 수행했을 때, 아래의 행위를 한다.
1. 영속성 컨텍스트에 엔티티 저장
2. 수행될 SQL을 SQL 저장소에 저장  
3. 최종 커밋 시 영속성 컨텍스트를 플러시(db에 반영)한다.
