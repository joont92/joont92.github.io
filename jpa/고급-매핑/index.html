<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="상속 관계 매핑 RDB는 객체지향 언어처럼 상속이라는 개념이 없다. 대신 슈퍼타입 서브타입 관계라는 모델링 기법이 있는데, 이게 상속 개념과 가장 유사하다. 상속 관계 매핑 기법은 물리 모델로 구현된 어떠한 슈퍼타입 서브타입 관계든, 객체 지향 상속 기법으로 추상화해서 접근할 수 있게 해준다는 것이 핵심이다. DB를 슈퍼타입 서브타입 관계의 조인 전략으로">
<meta name="keywords" content="자바 ORM 표준 JPA 프로그래밍,@MappedSuperClass,@IdClass,@EmbeddedId,@JoinTable,@SecondaryTable">
<meta property="og:type" content="article">
<meta property="og:title" content="[jpa] 고급 매핑">
<meta property="og:url" content="https://joont92.github.io/jpa/고급-매핑/index.html">
<meta property="og:site_name" content="기록은 기억의 연장선">
<meta property="og:description" content="상속 관계 매핑 RDB는 객체지향 언어처럼 상속이라는 개념이 없다. 대신 슈퍼타입 서브타입 관계라는 모델링 기법이 있는데, 이게 상속 개념과 가장 유사하다. 상속 관계 매핑 기법은 물리 모델로 구현된 어떠한 슈퍼타입 서브타입 관계든, 객체 지향 상속 기법으로 추상화해서 접근할 수 있게 해준다는 것이 핵심이다. DB를 슈퍼타입 서브타입 관계의 조인 전략으로">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://cloud2.zoolz.com/MyComputers/Images/Image.aspx?q=bT00MDcyNDcma2V5PTI5Mzk1NjU3NzcmdHlwZT1sJno9MjAxOC8xMi8xNSAwMjo1Mw==">
<meta property="og:image" content="https://cloud2.zoolz.com/MyComputers/Images/Image.aspx?q=bT00MDcyNDcma2V5PTI5Mzk1NjU3NzImdHlwZT1sJno9MjAxOC8xMi8xNSAwMjo1Mw==">
<meta property="og:image" content="https://cloud2.zoolz.com/MyComputers/Images/Image.aspx?q=bT00MDcyNDcma2V5PTI5Mzk1NjU3NzMmdHlwZT1sJno9MjAxOC8xMi8xNSAwMjo1Mw==">
<meta property="og:updated_time" content="2020-11-02T10:09:30.457Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[jpa] 고급 매핑">
<meta name="twitter:description" content="상속 관계 매핑 RDB는 객체지향 언어처럼 상속이라는 개념이 없다. 대신 슈퍼타입 서브타입 관계라는 모델링 기법이 있는데, 이게 상속 개념과 가장 유사하다. 상속 관계 매핑 기법은 물리 모델로 구현된 어떠한 슈퍼타입 서브타입 관계든, 객체 지향 상속 기법으로 추상화해서 접근할 수 있게 해준다는 것이 핵심이다. DB를 슈퍼타입 서브타입 관계의 조인 전략으로">
<meta name="twitter:image" content="https://cloud2.zoolz.com/MyComputers/Images/Image.aspx?q=bT00MDcyNDcma2V5PTI5Mzk1NjU3NzcmdHlwZT1sJno9MjAxOC8xMi8xNSAwMjo1Mw==">



  <link rel="alternate" href="/feed.xml" title="기록은 기억의 연장선" type="application/atom+xml">



  
  
  <link rel="canonical" href="https://joont92.github.io/jpa/고급-매핑/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>[jpa] 고급 매핑 | 기록은 기억의 연장선</title>
  




  <script async src="//www.googletagmanager.com/gtag/js?id=UA-110551662-1"></script>
  <script>
    var host = window.location.hostname;
    if (host !== "localhost" || !true) {
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-110551662-1');
    }
  </script>









  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">기록은 기억의 연장선</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">더 많은 것을 기억하기 위해 기록합니다</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    
  
  

  

  <a href="https://github.com/joont92" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="external nofollow noopener noreferrer" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://joont92.github.io/jpa/고급-매핑/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="JunYoung Park">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="기록은 기억의 연장선">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">[jpa] 고급 매핑

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-12-13 23:11:12" itemprop="dateCreated datePublished" datetime="2018-12-13T23:11:12+00:00">2018-12-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-11-02 10:09:30" itemprop="dateModified" datetime="2020-11-02T10:09:30+00:00">2020-11-02</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/jpa/" itemprop="url" rel="index"><span itemprop="name">jpa</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/jpa/고급-매핑/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="jpa/고급-매핑/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="상속-관계-매핑"><a class="markdownIt-Anchor" href="#상속-관계-매핑"></a> 상속 관계 매핑</h1>
<p>RDB는 객체지향 언어처럼 상속이라는 개념이 없다.<br>
대신 <code>슈퍼타입 서브타입 관계</code>라는 모델링 기법이 있는데, 이게 상속 개념과 가장 유사하다.<br>
상속 관계 매핑 기법은<br>
물리 모델로 구현된 어떠한 <code>슈퍼타입 서브타입 관계</code>든, 객체 지향 상속 기법으로 추상화해서 접근할 수 있게 해준다는 것이 핵심이다.<br>
<strong>DB를 슈퍼타입 서브타입 관계의 조인 전략으로 모델링했든, 단일 테이블 전략으로 모델링했든 객체 입장에서는 동일한 상속 구조로 접근할 수 있다.</strong></p>
<h2 id="각각의-테이블로-변환조인-전략"><a class="markdownIt-Anchor" href="#각각의-테이블로-변환조인-전략"></a> 각각의 테이블로 변환(조인 전략)</h2>
<p>엔티티 각각(자식, 부모 전부)을 테이블로 만들고, 자식 테이블이 부모의 기본키를 받아서 <code>기본키 + 외래키</code>로 사용하는 방법이다.</p>
<p><img src="https://cloud2.zoolz.com/MyComputers/Images/Image.aspx?q=bT00MDcyNDcma2V5PTI5Mzk1NjU3NzcmdHlwZT1sJno9MjAxOC8xMi8xNSAwMjo1Mw==" alt="joined tale"></p>
<p>클래스 상속 구조랑 가깝게 생기긴 했다.</p>
<ul>
<li>
<p>장점</p>
<ul>
<li>테이블이 정규화된다</li>
<li>외래키 참조 무결성 제약 조건 사용 가능</li>
<li>저장 공간을 효율적으로 사용함(불필요하게 null을 넣는 부분이 없으므로)</li>
</ul>
</li>
<li>
<p>단점</p>
<ul>
<li>조회할 때 항상 조인해서 들고와야함</li>
<li>등록할 때 INSERT를 항상 2번 실행해야함</li>
</ul>
</li>
</ul>
<p>초반에 모든 것이 예측된 케이스가 아니라면 이 전략을 사용할 일이 별로 없을 것 같다.<br>
객체는 리팩토링을 통해서 공통 부분을 추출해내는 등 자유롭게 변경될 수 있지만, 데이터베이스는 마이그레이션이 필요하기 때문이다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 엔티티 정의</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Inheritance</span>(strategy = InheritanceType.JOINED) <span class="comment">// 1</span></span><br><span class="line"><span class="meta">@DiscriminatorColumn</span>(name = <span class="string">"DTYPE"</span>) <span class="comment">// 2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Item</span></span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> price;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@DiscriminatorValue</span>(<span class="string">"A"</span>) <span class="comment">// 3</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Album</span> <span class="keyword">extends</span> <span class="title">Item</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String author;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@DiscriminatorValue</span>(<span class="string">"M"</span>) <span class="comment">// 3</span></span><br><span class="line"><span class="meta">@PrimaryKeyJoinColumn</span>(name = <span class="string">"MOVIE_ID"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Movie</span> <span class="keyword">extends</span> <span class="title">Item</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String director;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String actor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 등록, 조회</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Album album = <span class="keyword">new</span> Album();</span><br><span class="line">    <span class="comment">// set...</span></span><br><span class="line"></span><br><span class="line">    em.persist(album);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">select</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Album album = em.find(Album.class, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>사용하는 부분은 별로 다를 것 없다.</p>
<ol>
<li>상속 매핑을 사용할 것이고, <code>조인 전략</code>을 사용할 것이라는 의미이다.</li>
<li>자식 테이블을 구분할 컬럼이다. 실제 테이블의 컬럼으로 생성된다. 기본값이 DTYPE 이다.</li>
</ol>
<blockquote>
<p>조인 전략에서는 이 컬럼이 생략 가능하다.(hibernate는 그렇고, 다른 구현체는 아닐수도 있다)<br>
자식으로 직접 접근할때는(e.g. Album 엔티티로 접근) 생략해도 문제가 되지 않는데, 부모로 직접 접근할때는(e.g. 통계를 위해 Item 엔티티로 접근) TYPE이 없으면 해당 데이터가 어느 데이터를 나타내는지 알 수 없다.<br>
그러므로 hibernate는 아래와 같은 전략을 선택한다.</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="comment">-- ~~~</span></span><br><span class="line">    <span class="keyword">case</span> </span><br><span class="line">        <span class="comment">-- 상속된 테이블의 개수만큼 when 반복</span></span><br><span class="line">        <span class="keyword">when</span> itemlist0_1_.id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> </span><br><span class="line">        <span class="keyword">when</span> itemlist0_2_.id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">2</span> </span><br><span class="line">        <span class="keyword">when</span> itemlist0_.id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">0</span> </span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">as</span> clazz_1_ </span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    item itemlist0_ </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span></span><br><span class="line">    movie itemlist0_1_ </span><br><span class="line">        <span class="keyword">on</span> itemlist0_.id=itemlist0_1_.id </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span></span><br><span class="line">    album itemlist0_2_ </span><br><span class="line">        <span class="keyword">on</span> itemlist0_.id=itemlist0_2_.id </span><br><span class="line"><span class="comment">-- 상속된 테이블의 개수만큼 left join 반복</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>결국 이런식으로 처리되기 때문에, TYPE을 지정해주는 것이 좋다.</p>
</blockquote>
<ol start="3">
<li>구분 컬럼에 저장될 값이다. 생략하면 엔티티 이름을 사용한다.</li>
</ol>
<blockquote>
<p><a href="https://stackoverflow.com/questions/3639225/single-table-inheritance-strategy-using-enums-as-discriminator-value" rel="external nofollow noopener noreferrer" target="_blank">https://stackoverflow.com/questions/3639225/single-table-inheritance-strategy-using-enums-as-discriminator-value</a><br>
@DiscriminatorValue에 enum을 사용하는 방법이라는데, 왜 이렇게 쓰는지 모르겠다.</p>
</blockquote>
<ol start="4">
<li>기본적으로 자식 테이블은 부모 테이블의 ID 컬럼명을 그대로 사용하는데, 이를 바꿔주고 싶을 때 사용한다.</li>
</ol>
<p>실행결과</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 삽입</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ITEM(<span class="keyword">id</span>, <span class="keyword">name</span>, price, DTYPE) <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="string">'앨범'</span>, <span class="number">10000</span>, <span class="string">'A'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ALBUM(<span class="keyword">id</span>, author) <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="string">'소녀시대'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ITEM(<span class="keyword">id</span>, <span class="keyword">name</span>, price, DTYPE) <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="string">'인셉션'</span>, <span class="number">10000</span>, <span class="string">'M'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> MOVIE(<span class="keyword">id</span>, director, actor) <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="string">'크리스토퍼 놀란'</span>, <span class="string">'디카프리오'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 조회</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    *</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    album album0_ </span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span></span><br><span class="line">    item album0_1_ </span><br><span class="line">        <span class="keyword">on</span> album0_.id=album0_1_.id </span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    album0_.id = <span class="number">1</span></span><br><span class="line">    <span class="comment">-- and i.DTYPE = 'A'</span></span><br></pre></td></tr></table></figure>
<p>(hibernate에서는 조건절에 따로 DTYPE이 추가되지 않았다)</p>
<h2 id="통합-테이블로-변환단일-테이블-전략"><a class="markdownIt-Anchor" href="#통합-테이블로-변환단일-테이블-전략"></a> 통합 테이블로 변환(단일 테이블 전략)</h2>
<p>전략 이름 그대로 하나의 테이블에 다 때려넣는 전략이다.<br>
저장된 서브 타입마다 사용하지 않는 컬럼들에는 null이 들어가게 된다.</p>
<p><img src="https://cloud2.zoolz.com/MyComputers/Images/Image.aspx?q=bT00MDcyNDcma2V5PTI5Mzk1NjU3NzImdHlwZT1sJno9MjAxOC8xMi8xNSAwMjo1Mw==" alt="single table"></p>
<p>조인 전략과 달리 구분 컬럼은 생략이 불가능하다.<br>
생략하면 기본값이 사용된다.</p>
<ul>
<li>
<p>장점</p>
<ul>
<li>조인이 필요없다</li>
</ul>
</li>
<li>
<p>단점</p>
<ul>
<li>자식 엔티티가 매핑한 컬럼은 모두 null을 허용해야 한다.(데이터 관점에서 아주 좋지 않음)</li>
<li>단일 테이블에 모든 것을 저장하므로 테이블이 커질 수 있다. 그러므로 오히려 성능이 느려질 수 있다.</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Inheritance</span>(strategy = InheritanceType.SINGLE_TABLE) <span class="comment">// 1</span></span><br><span class="line"><span class="meta">@DiscriminatorColumn</span>(name = <span class="string">"DTYPE"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Item</span></span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> price;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@DiscriminatorValue</span>(<span class="string">"A"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Album</span> <span class="keyword">extends</span> <span class="title">Item</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@DiscriminatorValue</span>(<span class="string">"M"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Movie</span> <span class="keyword">extends</span> <span class="title">Item</span></span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><code>단일 테이블 전략</code>을 사용할 것이라는 의미이다.</li>
</ol>
<p>실행 결과</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 삽입</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ITEM(<span class="keyword">id</span>, <span class="keyword">name</span>, price, artist, DTYPE) <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="string">'앨범'</span>, <span class="number">10000</span>, <span class="string">'소녀시대'</span>, <span class="string">'A'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 조회</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    *</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    item album0_ </span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    album0_.id=<span class="number">1</span>  </span><br><span class="line">    <span class="keyword">and</span> album0_.DTYPE=<span class="string">'A'</span></span><br></pre></td></tr></table></figure>
<h2 id="서브타입-테이블로-변환구현-클래스마다-테이블-전략"><a class="markdownIt-Anchor" href="#서브타입-테이블로-변환구현-클래스마다-테이블-전략"></a> 서브타입 테이블로 변환(구현 클래스마다 테이블 전략)</h2>
<p>실제 데이터들을 모두 별도의 테이블에 저장하는 방법이다.<br>
테이블이 모두 별개이다 보니, 공통 부분에 대한 내용이 보장되지도 않고, 관리하기도 힘들다.<br>
쿼리도 전부 UNION으로 날라가서 성능 로스가 극심하다.</p>
<p><img src="https://cloud2.zoolz.com/MyComputers/Images/Image.aspx?q=bT00MDcyNDcma2V5PTI5Mzk1NjU3NzMmdHlwZT1sJno9MjAxOC8xMi8xNSAwMjo1Mw==" alt="concrete table"></p>
<p>데이터베이스 설계자와 객체지향 설계자 둘 다 추천하지 않는 방법이다.<br>
조인이나 단일 테이블 전략을 고려하는 것이 좋다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Inheritance</span>(strategy = InheritanceType.TABLE_PER_CLASS) <span class="comment">// 1</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Item</span></span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> price;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@DiscriminatorValue</span>(<span class="string">"A"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Album</span> <span class="keyword">extends</span> <span class="title">Item</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@DiscriminatorValue</span>(<span class="string">"M"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Movie</span> <span class="keyword">extends</span> <span class="title">Item</span></span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><code>구현 클래스마다 테이블 전략</code>을 사용하겠다는 의미이다.</li>
</ol>
<h1 id="매핑-정보만-상속mappedsuperclass"><a class="markdownIt-Anchor" href="#매핑-정보만-상속mappedsuperclass"></a> 매핑 정보만 상속(@MappedSuperClass)</h1>
<p>부모 클래스는 테이블과 매핑하지 않고 부모 클래스를 상속 받는 자식 클래스에게 <code>매핑 정보만 제공하고 싶을 경우</code> 사용한다.<br>
단순히 매핑 정보만 상속할 목적으로 사용한다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MappedSuperClass</span> <span class="comment">// 1</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseEntity</span></span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Temporal</span>(TemporalType.TIMESTAMP)</span><br><span class="line">    <span class="keyword">private</span> Date createdDate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Temporal</span>(TemporalType.TIMESTAMP)</span><br><span class="line">    <span class="keyword">private</span> Date lastModifiedDate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Member</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@AttributeOverride</span>(name = <span class="string">"id"</span>, column = <span class="meta">@Column</span>(name = <span class="string">"TEAM_ID"</span>)) <span class="comment">// 2</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Team</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>BaseEntity</code>는 테이블과 매핑되지 않고 단순히 자식 엔티티에게 매핑 정보만 제공하는 용도로 사용된다.<br>
(참고로 ORM에서 말하는 진정한 상속 매핑은 처음 설명했던 <code>상속 관계 매핑</code>을 말한다.)</p>
<ol>
<li>매핑 정보만 제공할 클래스라는 의미이다.</li>
<li>매핑정보를 재정의 하고 싶을 경우 사용한다. 여러개를 지정하고 싶을 경우 <code>@AttributeOverrides</code>를 사용한다.</li>
<li>위에 명시하진 않았지만 관계를 재정의 하고 싶을 경우 <code>@AssociationOverride</code>를 사용한다.</li>
</ol>
<p>근데 이것보다 그냥 <code>@Embeddable</code>을 쓰는게 나을 것 같다.<br>
<code>@MappedSuperClass</code>는 추상 클래스만이 가능한데, 다중 상속이 안되는 자바에서 단순히 매핑 정보를 추가 정의하기 위해 상속을 써버리는 것은 좋지 않은 것 같다…<br>
일단 위에는 createdDate, lastModifiedDate로 작성했지만, 이렇게 사용하는게 좋은 예시는 아닌 것 같다.</p>
<h1 id="복합키-매핑"><a class="markdownIt-Anchor" href="#복합키-매핑"></a> 복합키 매핑</h1>
<p>JPA에서 식별자를 둘 이상 사용하려면 별도의 식별자 클래스를 만들어야 한다.<br>
그냥 자바 기본 타입 2개 쓰고 @Id 선언하면 안된다.</p>
<p>JPA에서 별도의 식별자 클래스를 만드는 방법은 2가지가 있다.<br>
두 방식의 장단점이 있으니, 원하는 방식을 선택해서 일관성 있게 하나만 사용하는 것이 좋다.</p>
<h2 id="idclass"><a class="markdownIt-Anchor" href="#idclass"></a> @IdClass</h2>
<p>@IdClass를 이용한 복합키 선언은 아래와 같다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@IdClass</span>(ParendId.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Parent</span></span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"PARENT_ID1"</span>)</span><br><span class="line">    <span class="keyword">private</span> String id1;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"PARENT_ID2"</span>)</span><br><span class="line">    <span class="keyword">private</span> String id2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParentId</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String id1; <span class="comment">// Parent.id1 에 대한 정보 제공</span></span><br><span class="line">    <span class="keyword">private</span> String id2; <span class="comment">// Parent.id2 에 대한 정보 제공</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// equals, hashCode</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@IdClass가 정보 제공용도(식별자 정보는 여기를 참고해라) 정도로 쓰이고 있다.<br>
@IdClass로 사용된 식별자 클래스는 아래 조건을 만족해야 한다.</p>
<ul>
<li><strong>식별자 클래스의 속성명과 엔티티에서 사용하는 식별자의 속성명이 같아야 함</strong></li>
</ul>
<blockquote>
<p><code>Entity에 매핑 정보를 적고, IdClass에서 해당 변수명에 맞춰 정보를 제공</code>해주고 있다.<br>
아래 <code>식별/비식별 관계에서 복합키 사용</code> 매핑하는 부분에서 더 상세히 볼 수 있다.</p>
</blockquote>
<ul>
<li>Serializable 인터페이스 구현해야 함</li>
<li>equals, hashCode 구현해야함</li>
<li>기본 생성자 필요</li>
<li>식별자 클래스는 public 이어야 함</li>
</ul>
<p>실제 사용은 아래와 같다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// save</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Parent parent = <span class="keyword">new</span> Parent();</span><br><span class="line">    parent.setId1(<span class="string">"id1"</span>);</span><br><span class="line">    parent.setId2(<span class="string">"id2"</span>);</span><br><span class="line">    </span><br><span class="line">    em.persist(parent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// select</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">select</span><span class="params">()</span>&#125;</span>&#123;</span><br><span class="line">    ParentId parentId = <span class="keyword">new</span> ParentId(<span class="string">"id1"</span>, <span class="string">"id2"</span>);</span><br><span class="line">    Parent foundParent = em.find(Parent.class, parentId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@IdClass의 장점은 엔티티에 flat한 attribute를 제공해서 그나마 RDB와 가깝다는 것인데, 저장만 그렇지 조회는 또 그렇지도 않다.<br>
(저장의 경우  em.persist를 호출하면 JPA가 내부에서 Parent.id1, Parent.id2 값을 이용해서 ParentId를 생성하고 영속성 컨텍스트의 키로 사용한다.)</p>
<h2 id="embededid"><a class="markdownIt-Anchor" href="#embededid"></a> @EmbededId</h2>
<p>@IdClass보다 좀 더 객체지향적인 방법이다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Parent</span></span>&#123;</span><br><span class="line">    <span class="meta">@EmbeddedId</span></span><br><span class="line">    <span class="keyword">private</span> ParentId id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Embeddable</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParentId</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"PARENT_ID1"</span>)</span><br><span class="line">    <span class="keyword">private</span> String id1;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"PARENT_ID2"</span>)</span><br><span class="line">    <span class="keyword">private</span> String id2;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// equals, hashCode</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(사용하는 쪽에서 @EmbeddedId로 사용하므로 @Id를 사용할 필요없고, 복합키이므로 자동생성을 사용할 수 없다)<br>
@IdClass 처럼 정보 제공 용도로 사용하지 않고 직접 엔티티에서 사용해버렸다.<br>
매핑 정보도 ParentId 클래스에 들어감으로써 키를 명확히 하나의 클래스로 분리한 느낌이난다. 좀 더 객체지향적인 방법이다.(id1에 접근하고자 할 경우 <code>entity.getId().getId1()</code>처럼, 언뜻보기에 좀 이상한 접근법이 사용되긴 하지만)</p>
<p>@EmbeddedId를 사용한 식별자 클래스는 아래 조건을 만족해야 한다.</p>
<ul>
<li>@Embeddable 어노테이션을 붙여주어야 함</li>
<li>Serializable 인터페이스 구현해야 함</li>
<li>equals, hashCode 구현해야함</li>
<li>기본 생성자 필요</li>
<li>식별자 클래스는 public 이어야 함</li>
</ul>
<p>실제 사용은 아래와 같다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// save</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Parent parent = Parent.builder()</span><br><span class="line">        .id(<span class="keyword">new</span> ParentId(<span class="string">"id1"</span>, <span class="string">"id2"</span>))</span><br><span class="line">        .build();</span><br><span class="line">    </span><br><span class="line">    em.persist(parent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// select</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">select</span><span class="params">()</span>&#125;</span>&#123;</span><br><span class="line">    ParentId parentId = <span class="keyword">new</span> ParentId(<span class="string">"id1"</span>, <span class="string">"id2"</span>);</span><br><span class="line">    Parent foundParent = em.find(Parent.class, parentId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>의문 : @EmbeddedId 사용시 JPQL에서 id.id1 의 형태로 접근해야하는데, delegate 메서드를 활용할 순 없나?</strong><br>
결과 : 엔티티의 대상이 필드이기 때문에 delegate 메서드로는 불가능하다 (대상이 아니기때문)</p>
</blockquote>
<h2 id="복합키의-equals-hashcode"><a class="markdownIt-Anchor" href="#복합키의-equals-hashcode"></a> 복합키의 equals, hashCode</h2>
<p>위의 복합키 조건을 보면 equals와 hashCode를 필수로 구현해줘야 한다고 하는데,<br>
이는 JPA는 영속성 컨텍스트에 엔티티를 보관할 때 엔티티의 식별자를 키로 사용하고,<br>
식별자를 구분하기 위해 equals와 hashCode를 사용해서 동등성 비교를 하기 때문이다.</p>
<p>이게 단일 식별자일 경우에는 자바의 기본 타입을 사용하므로 별 문제없이 동등성이 보장되지만,<br>
복합 식별자일 경우에는 클래스를 사용하므로 equals와 hashCode를 구현해주지 않으면 동등성을 보장할 수 없다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ParentId id1 = <span class="keyword">new</span> ParentId(<span class="string">"id1"</span>, <span class="string">"id2"</span>);</span><br><span class="line">ParentId id2 = <span class="keyword">new</span> Parentid(<span class="string">"id1"</span>, <span class="string">"id2"</span>);</span><br><span class="line"></span><br><span class="line">assertTrue(id1.equas(id2)); <span class="comment">// fail</span></span><br></pre></td></tr></table></figure>
<p>같은 id 값을 가졌지만, 동등하지 않은 것이 된다.<br>
java는 equals, hashCode를 오버라이드 하지 않으면 기본적으로 Object의 것을 사용하기 때문이다.<br>
기본적으로 Object의 equals는 동일성 비교(==)를 하기 때문에 위의 두 키는 동등하지 않은 것이 된다.</p>
<p>JPA는 엔티티의 식별자를 가지고 영속성 컨텍스트를 관리하기 때문에<br>
식별자의 동등성이 지켜지지 않으면 예상과 다른 엔티티가 조회되거나 엔티티를 찾을 수 없는 등 심각한 문제가 발생할 수 있다.<br>
그러므로 equals와 hashCode는 필수로 구현해줘야 한다.</p>
<h1 id="식별비식별-관계에서-복합키-사용"><a class="markdownIt-Anchor" href="#식별비식별-관계에서-복합키-사용"></a> 식별/비식별 관계에서 복합키 사용</h1>
<h2 id="식별-관계와-비식별-관계"><a class="markdownIt-Anchor" href="#식별-관계와-비식별-관계"></a> 식별 관계와 비식별 관계</h2>
<h3 id="식별관계"><a class="markdownIt-Anchor" href="#식별관계"></a> 식별관계</h3>
<p>부모 테이블의 기본키를 내려받아서 자식 테이블의 기본키 + 외래키로 사용하는 관계이다.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">parent</span>(</span><br><span class="line">    parent_id <span class="built_in">integer</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(parent_id)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">child</span>(</span><br><span class="line">    parent_id <span class="built_in">integer</span>,</span><br><span class="line">    child_id <span class="built_in">integer</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(parent_id, child_id),</span><br><span class="line">    FOREIGN <span class="keyword">KEY</span>(parent_id) <span class="keyword">REFERENCES</span> <span class="keyword">parent</span>(parent_id)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="비식별-관계"><a class="markdownIt-Anchor" href="#비식별-관계"></a> 비식별 관계</h3>
<p>부모 테이블의 기본키를 내려받아서 자식 테이블의 외래키로만 사용하는 관계이다.<br>
요즘은 비식별 관계를 주로 사용하고, 필요할 때만 식별 관계를 사용하는 추세이다.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">parent</span>(</span><br><span class="line">    parent_id <span class="built_in">integer</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(parent_id)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">child</span>(</span><br><span class="line">    parent_id <span class="built_in">integer</span>,</span><br><span class="line">    child_id <span class="built_in">integer</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(child_id),</span><br><span class="line">    FOREIGN <span class="keyword">KEY</span>(parent_id) <span class="keyword">REFERENCES</span> <span class="keyword">parent</span>(parent_id)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ol>
<li>필수적 비식별 관계 : FK NOT NULL(INNER JOIN 사용됨)</li>
<li>선택적 비식별 관계 : FK NULLALBE(OUTER JOIN 사용됨)</li>
</ol>
<h2 id="식별-관계-매핑"><a class="markdownIt-Anchor" href="#식별-관계-매핑"></a> 식별 관계 매핑</h2>
<p>부모, 자식, 손자까지 계속 기본키를 전달하는 식별관계이다.<br>
식별관계는 부모의 키를 포함해 복합키를 구성해야 하므로 @IdClass나 @EmbeddedId를 사용해야 한다.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">parent</span>(</span><br><span class="line">    parent_id <span class="built_in">integer</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(parent_id)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">child</span>(</span><br><span class="line">    parent_id <span class="built_in">integer</span>,</span><br><span class="line">    child_id <span class="built_in">integer</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(parent_id, child_id),</span><br><span class="line">    FOREIGN <span class="keyword">KEY</span>(parent_id) <span class="keyword">REFERENCES</span> <span class="keyword">parent</span>(parent_id)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> grandchild(</span><br><span class="line">    parent_id <span class="built_in">integer</span>,</span><br><span class="line">    child_id <span class="built_in">integer</span>,</span><br><span class="line">    grandchild_id <span class="built_in">integer</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(parent_id, child_id, grandchild_id),</span><br><span class="line">    FOREIGN <span class="keyword">KEY</span>(parent_id) <span class="keyword">REFERENCES</span> <span class="keyword">parent</span>(parent_id),</span><br><span class="line">    FOREIGN <span class="keyword">KEY</span>(child_id) <span class="keyword">REFERENCES</span> <span class="keyword">child</span>(child_id)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="idclass-2"><a class="markdownIt-Anchor" href="#idclass-2"></a> @IdClass</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Parent</span></span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String parentId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@IdClass</span>(ChildId.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Child</span></span>&#123;</span><br><span class="line">    <span class="comment">// 매핑 정보 나열</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@ManyToOne</span></span><br><span class="line">    <span class="meta">@JoinColumn</span>(name = <span class="string">"parent_id"</span>)</span><br><span class="line">    <span class="keyword">private</span> Parent parent;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String childId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChildId</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String parent; <span class="comment">// Child.parent 에 대한 정보 제공</span></span><br><span class="line">    <span class="keyword">private</span> String childId; <span class="comment">// Child.childId 에 대한 정보 제공</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@IdClass</span>(GrandChildId.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GrandChild</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@ManyToOne</span></span><br><span class="line">    <span class="meta">@JoinColumns</span>(&#123;</span><br><span class="line">            <span class="meta">@JoinColumn</span>(name = <span class="string">"parent_id"</span>),</span><br><span class="line">            <span class="meta">@JoinColumn</span>(name = <span class="string">"child_id"</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">private</span> Child child;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String grandChildId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GrandChildId</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ChildId child; <span class="comment">// GrandChild.child 에 대한 정보 제공</span></span><br><span class="line">    <span class="keyword">private</span> String grandChildId; <span class="comment">// GrandChild.grandChildId 에 대한 정보 제공</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@IdClass가 pk에 매핑되는 애들에게 정보를 바로 제공하고 있다.</p>
<h3 id="embeddedid"><a class="markdownIt-Anchor" href="#embeddedid"></a> @EmbeddedId</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String parentId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Child</span> </span>&#123;</span><br><span class="line">    <span class="meta">@EmbeddedId</span></span><br><span class="line">    <span class="keyword">private</span> ChildId childId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@MapsId</span>(<span class="string">"parentId"</span>)</span><br><span class="line">    <span class="meta">@ManyToOne</span></span><br><span class="line">    <span class="meta">@JoinColumn</span>(name = <span class="string">"parent_id"</span>)</span><br><span class="line">    <span class="keyword">private</span> Parent parent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="meta">@Embeddable</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChildId</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String parentId; <span class="comment">// @MapsId("paretnId") 로 매핑</span></span><br><span class="line">    <span class="keyword">private</span> String childId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GrandChild</span> </span>&#123;</span><br><span class="line">    <span class="meta">@EmbeddedId</span></span><br><span class="line">    <span class="keyword">private</span> GrandChildId grandChildId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@MapsId</span>(<span class="string">"childId"</span>)</span><br><span class="line">    <span class="meta">@ManyToOne</span></span><br><span class="line">    <span class="meta">@JoinColumns</span>(&#123;</span><br><span class="line">            <span class="meta">@JoinColumn</span>(name = <span class="string">"parent_id"</span>),</span><br><span class="line">            <span class="meta">@JoinColumn</span>(name = <span class="string">"child_id"</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">private</span> Child child;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="meta">@Embeddable</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GrandChildId</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ChildId childId; <span class="comment">// @MapsId("childId") 로 매핑</span></span><br><span class="line">    <span class="keyword">private</span> String grandChildId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>id들을 따로 묶고 @MapsId를 통해 연관관계와 id를 연결했다.<br>
(@IdClass에서 id들을 class로 모으는 과정이 추가된 형태라고 봐도 될듯하다.)</p>
<blockquote>
<p>@mapsid는 @id로 지정한 컬럼에 @OnetoOne이나 @ManyToOne 관계를 매핑시키는 역할을 한다.<br>
<a href="http://docs.jboss.org/hibernate/jpa/2.2/api/javax/persistence/MapsId.html" rel="external nofollow noopener noreferrer" target="_blank">http://docs.jboss.org/hibernate/jpa/2.2/api/javax/persistence/MapsId.html</a><br>
매핑의 대상이 되는 속성은 @OnetoOne이나 @ManyToOne의 기본키와 타입이 같아야한다.</p>
</blockquote>
<p>※ 번외로 아래와 같이 세팅 할수도 있는데, 이는 잘못된 방식이다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String parentId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Child</span> </span>&#123;</span><br><span class="line">    <span class="meta">@EmbeddedId</span></span><br><span class="line">    <span class="keyword">private</span> ChildId childId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="meta">@Embeddable</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChildId</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@ManyToOne</span></span><br><span class="line">    <span class="meta">@JoinColumn</span>(name = <span class="string">"parent_id"</span>)</span><br><span class="line">    <span class="keyword">private</span> Parent parent;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String childId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GrandChild</span> </span>&#123;</span><br><span class="line">    <span class="meta">@EmbeddedId</span></span><br><span class="line">    <span class="keyword">private</span> GrandChildId grandChildId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="meta">@Embeddable</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GrandChildId</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@ManyToOne</span></span><br><span class="line">    <span class="meta">@JoinColumns</span>(&#123;</span><br><span class="line">            <span class="meta">@JoinColumn</span>(name = <span class="string">"parent_id"</span>),</span><br><span class="line">            <span class="meta">@JoinColumn</span>(name = <span class="string">"child_id"</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">private</span> Child child;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String grandChildId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>얼핏보면 more 객체지향스럽긴 하지만,<br>
연관관계를 항상 id를 통해 접근하는 이상한 방식이 탄생하게 되고,<br>
@Embeddable 에서 연관관계까지 equals, hashCode의 대상이 되는 이상한 구조가 탄생한다.<br>
id는 id대로 놔둬야 한다.</p>
<h3 id="일대일-식별-관계featmapsid"><a class="markdownIt-Anchor" href="#일대일-식별-관계featmapsid"></a> 일대일 식별 관계(feat.@MapsId)</h3>
<p>일대일 식별 관계는 자식 테이블의 기본키 값으로 부모 테이블의 기본키 값을 사용하는 조금 특별한 관계이다.<br>
이 경우 연관관계의 주인이 될 외래키 칼럼이 없으므로 @MapsId를 사용하여 매핑해줘야 한다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Board</span></span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Long boardId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OneToOne</span>(mappedBy = <span class="string">"board"</span>)</span><br><span class="line">    <span class="keyword">private</span> BoardDetail boardDetail;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoardDetail</span></span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Long boardId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Lob</span></span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@MapsId</span>(<span class="string">"boardId"</span>)</span><br><span class="line">    <span class="meta">@OneToOne</span></span><br><span class="line">    <span class="meta">@JoinColumn</span>(name = <span class="string">"board_id"</span>)</span><br><span class="line">    <span class="keyword">private</span> Board board;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>board.getBoardDetail().getContent()</code>로 접근해야해서 사용이 조금 자연스럽지 않게 느껴지지만, <code>@Delegate</code> 같은것으로 충분히 해결할 수 있다.</p>
<h2 id="비식별-관계-매핑"><a class="markdownIt-Anchor" href="#비식별-관계-매핑"></a> 비식별 관계 매핑</h2>
<p>비식별 관계는 복합키를 사용하지 않기 때문에 아주 심플하다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String parentId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Child</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String childId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ManyToOne</span></span><br><span class="line">    <span class="meta">@JoinColumn</span>(name = <span class="string">"parent_id"</span>)</span><br><span class="line">    <span class="keyword">private</span> Parent parent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GrandChild</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String grandChildId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ManyToOne</span></span><br><span class="line">    <span class="meta">@JoinColumn</span>(name = <span class="string">"child_id"</span>)</span><br><span class="line">    <span class="keyword">private</span> Child child;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="그래서-식별이냐-비식별이냐"><a class="markdownIt-Anchor" href="#그래서-식별이냐-비식별이냐"></a> 그래서 식별이냐 비식별이냐?</h2>
<p>데이터베이스 설계관점에서 보면, 아래와 같은 이유로 비식별 관계를 선호한다.</p>
<ul>
<li>식별 관계는 부모 테이블의 기본키를 자식 테이블로 전파하면서 자식 테이블의 기본키 컬럼이 점점 늘어나는 구조이다.<br>
depth가 깊어질수록 기본키 인덱스가 불필요하게 커지고, 조인할 때 SQL이 복잡해진다.</li>
<li>식별 관계는 2개 이상의 컬럼을 묶어서 복합 기본키를 만들어야 하는 경우가 많다.<br>
복합 기본키는 컬럼이 하나인 단일 기본키보다 작성하는데 많은 노력이 필요하다.</li>
<li>식별 관계의 경우 기본키로 비즈니스 로직이 있는 자연키 컬럼을 조합하는 경우가 많고,<br>
비식별 관계의 경우 기본키로 비즈니스와 전혀 관계없는 대리키를 주로 사용한다.<br>
변하지 않는 요구사항이란 세상에 존재하지 않는다. 자연키 컬럼 조합은 나중에 변경될 가능성이 있다.<br>
이런 상태에서 식별 관계로 구성할 경우 나중에 변경하기 매우 힘들어진다.</li>
</ul>
<blockquote>
<p>e.g. 주민등록번호</p>
</blockquote>
<ul>
<li>언급했듯이 비식별 관계의 경우 대리키를 주로 사용하는데, JPA는 @GeneratedValue 처럼 대리키를 생성하기 위한 편리한 방법을 제공한다.</li>
</ul>
<p>그래서 정리하면!</p>
<ul>
<li>될수있으면 비식별 관계를 사용하고</li>
<li>기본키는 Long 타입의 대리키를 사용히고</li>
<li>필수적 비식별 관계를 사용하자(<code>optional = false</code>)</li>
</ul>
<h1 id="조인-테이블"><a class="markdownIt-Anchor" href="#조인-테이블"></a> 조인 테이블</h1>
<p>데이터베이스의 테이블의 연관관계를 설정하는 방법은 총 2가지이다.</p>
<ul>
<li>조인 컬럼</li>
</ul>
<blockquote>
<p>일반적인 외래키 컬럼을 사용하여 연관관계를 관리하는 것</p>
</blockquote>
<ul>
<li>조인 테이블</li>
</ul>
<blockquote>
<p>별도의 테이블을 사용하여 연관관계를 관리하는 것</p>
</blockquote>
<p>조인 테이블의 경우 테이블을 하나 추가해야 된다는 단점이 있다.(추가 조인 필요)<br>
그러므로 기본적으로 조인 컬럼을 사용하고, 필요할 때만 조인 테이블을 사용하도록 해야한다.</p>
<blockquote>
<p>조인 테이블 == 연결 테이블 == 링크 테이블</p>
</blockquote>
<p>하나의 테이블이 여러 테이블과 관계를 맺을 수 있는 구조라던가,<br>
원래 관계가 없었는데 관계가 생겼다거나(FK를 일괄 추가하기에는 너무 부담스럽),<br>
관계 변경(update) 때문에 메인 테이블에 락이 걸리는 걸 방지하기 위해(연결 테이블만 컨트롤 하므로써 성능향상) 사용하는 등 여러 상황에서 사용될 수 있을 것이다.</p>
<h2 id="일대일-조인테이블"><a class="markdownIt-Anchor" href="#일대일-조인테이블"></a> 일대일 조인테이블</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OneToOne</span>(optional = <span class="keyword">false</span>)</span><br><span class="line">    <span class="meta">@JoinTable</span>(name = <span class="string">"a_b"</span>,</span><br><span class="line">            joinColumns = <span class="meta">@JoinColumn</span>(name = <span class="string">"a_id"</span>),</span><br><span class="line">            inverseJoinColumns = <span class="meta">@JoinColumn</span>(name = <span class="string">"b_id"</span>))</span><br><span class="line">    <span class="keyword">private</span> B b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OneToOne</span>(mappedBy = <span class="string">"b"</span>) <span class="comment">// optional</span></span><br><span class="line">    <span class="keyword">private</span> A a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>생성되는 DDL은 아래와 같다.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> A(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    primary <span class="keyword">key</span> (<span class="keyword">id</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> B (</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    primary <span class="keyword">key</span> (<span class="keyword">id</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> a_b (</span><br><span class="line">    b_id <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    a_id <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    primary <span class="keyword">key</span> (a_id),</span><br><span class="line">    FOREIGN <span class="keyword">KEY</span>(a_id) <span class="keyword">REFERENCES</span> A(a_id),</span><br><span class="line">    FOREIGN <span class="keyword">KEY</span>(b_id) <span class="keyword">REFERENCES</span> B(b_id)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> a_b </span><br><span class="line">    <span class="keyword">add</span> <span class="keyword">constraint</span> UK_pam4mvekk45ceoippm3ffvi2t <span class="keyword">unique</span> (b_id)</span><br></pre></td></tr></table></figure>
<p>a_id가 primary key, b_id에 unique constraints가 걸리면서 1:1 관계가 형성된다.</p>
<h2 id="다대일-조인테이블"><a class="markdownIt-Anchor" href="#다대일-조인테이블"></a> 다대일 조인테이블</h2>
<p>B를 <code>다</code>로 한다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ManyToOne</span></span><br><span class="line">    <span class="meta">@JoinTable</span>(name = <span class="string">"a_b"</span>,</span><br><span class="line">            joinColumns = <span class="meta">@JoinColumn</span>(name = <span class="string">"a_id"</span>),</span><br><span class="line">            inverseJoinColumns = <span class="meta">@JoinColumn</span>(name = <span class="string">"b_id"</span>))</span><br><span class="line">    <span class="keyword">private</span> A a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OneToMany</span>(mappedBy = <span class="string">"a"</span>) <span class="comment">// optional</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;B&gt; bList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> A(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    primary <span class="keyword">key</span> (<span class="keyword">id</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> B (</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    primary <span class="keyword">key</span> (<span class="keyword">id</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> a_b(</span><br><span class="line">    a_id <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    b_id <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(b_id),</span><br><span class="line">    FOREIGN <span class="keyword">KEY</span>(a_id) <span class="keyword">REFERENCES</span> A(a_id),</span><br><span class="line">    FOREIGN <span class="keyword">KEY</span>(b_id) <span class="keyword">REFERENCES</span> B(b_id)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>다 쪽이 primary key로 생성됨으로써 다대일 관계 형성이 가능하다.</p>
<h2 id="일대다-조인테이블"><a class="markdownIt-Anchor" href="#일대다-조인테이블"></a> 일대다 조인테이블</h2>
<p>일대다 조인컬럼처럼 <code>일</code>쪽에서 연관관계를 컨트롤 하고 싶을 경우 형성하는 방법이다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OneToMany</span></span><br><span class="line">    <span class="meta">@JoinTable</span>(name = <span class="string">"a_b"</span>,</span><br><span class="line">            joinColumns = <span class="meta">@JoinColumn</span>(name = <span class="string">"a_id"</span>),</span><br><span class="line">            inverseJoinColumns = <span class="meta">@JoinColumn</span>(name = <span class="string">"b_id"</span>))</span><br><span class="line">    <span class="keyword">private</span> List&lt;B&gt; bList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>일대다 조인컬럼때와 같이 단방향만을 지원한다.</p>
<p>아래는 생성되는 DDL이다.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> A(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    primary <span class="keyword">key</span> (<span class="keyword">id</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> B (</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    primary <span class="keyword">key</span> (<span class="keyword">id</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> a_b(</span><br><span class="line">    a_id <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    b_id <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    FOREIGN <span class="keyword">KEY</span>(a_id) <span class="keyword">REFERENCES</span> A(a_id),</span><br><span class="line">    FOREIGN <span class="keyword">KEY</span>(b_id) <span class="keyword">REFERENCES</span> B(b_id)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> a_b </span><br><span class="line">    <span class="keyword">add</span> <span class="keyword">constraint</span> UK_pam4mvekk45ceoippm3ffvi2t <span class="keyword">unique</span> (b_id)</span><br></pre></td></tr></table></figure>
<p>pk 대신 unique로 생성되는게 조금 다르다.</p>
<h2 id="다대다-조인테이블"><a class="markdownIt-Anchor" href="#다대다-조인테이블"></a> 다대다 조인테이블</h2>
<p>앞서 나왔으므로 작성하지 않겠다.<br>
parent_id, child_id 에 각각 FK가 생성되고, PK로 묶이지는 않는다.</p>
<h1 id="엔티티-하나에-여러-테이블-매핑"><a class="markdownIt-Anchor" href="#엔티티-하나에-여러-테이블-매핑"></a> 엔티티 하나에 여러 테이블 매핑</h1>
<p>아까 위의 일대일 식별 관계에서 나왔었던 형태이다.</p>
<blockquote>
<p>board와 board_detail을 나눠서 저장하고, 같은 PK를 쓰는 형태</p>
</blockquote>
<p>자주 사용하는 형태는 아니지만 가끔 나오기도 한다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@SecondaryTable</span>(name = <span class="string">"board_detail"</span>, <span class="comment">// 1</span></span><br><span class="line">    pkJoinColumns = <span class="meta">@PrimaryKeyJoinColumn</span>(name = <span class="string">"board_detail_id"</span>)) <span class="comment">// 2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Board</span></span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Long boardId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span>(table = <span class="string">"board_detail"</span>) <span class="comment">// 3</span></span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@SecondaryTable을 사용해 board_detail 테이블을 추가로 매핑했다.</p>
<ol>
<li>추가로 매핑할 테이블의 이름이다.</li>
<li>추가로 매핑된 테이블의 기본키 컬럼명이다.</li>
<li>추가로 매핑된 테이블에 저장될 속성이다.</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> board (</span><br><span class="line">    board_id <span class="built_in">BIGINT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    title <span class="built_in">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (board_id)</span><br><span class="line">)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> board_detail (</span><br><span class="line">    board_detail_id <span class="built_in">BIGINT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="keyword">content</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (board_detail_id)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>위의 일대일 식별관계와 반대로, <code>board.getContent()</code>로 접근할 수 있어 사용은 자연스럽다.<br>
하지만 이 방식의 경우, 매핑이 부자연스럽다.(lazy loading도 안된다)<br>
결과적으로 사용의 자연스러움 보다는 매핑의 자연스러움을 추구하는 것이 맞는것 같다. 그니까… 이거 어디서 쓸일은 없을꺼 같음…ㅋ</p>
<a id="more"></a>
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/자바-ORM-표준-JPA-프로그래밍/" rel="tag"># 자바 ORM 표준 JPA 프로그래밍</a>
          
            <a href="/tags/MappedSuperClass/" rel="tag"># @MappedSuperClass</a>
          
            <a href="/tags/IdClass/" rel="tag"># @IdClass</a>
          
            <a href="/tags/EmbeddedId/" rel="tag"># @EmbeddedId</a>
          
            <a href="/tags/JoinTable/" rel="tag"># @JoinTable</a>
          
            <a href="/tags/SecondaryTable/" rel="tag"># @SecondaryTable</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/java/java-mysql-연동시-오류/" rel="next" title="[java] java mysql 연동시 오류">
                <i class="fa fa-chevron-left"></i> [java] java mysql 연동시 오류
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/java/lombok-practice-정리/" rel="prev" title="[java] lombok practice 정리">
                [java] lombok practice 정리 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">JunYoung Park</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">182</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">18</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">344</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/feed.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#상속-관계-매핑"><span class="nav-number">1.</span> <span class="nav-text"> 상속 관계 매핑</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#각각의-테이블로-변환조인-전략"><span class="nav-number">1.1.</span> <span class="nav-text"> 각각의 테이블로 변환(조인 전략)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#통합-테이블로-변환단일-테이블-전략"><span class="nav-number">1.2.</span> <span class="nav-text"> 통합 테이블로 변환(단일 테이블 전략)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#서브타입-테이블로-변환구현-클래스마다-테이블-전략"><span class="nav-number">1.3.</span> <span class="nav-text"> 서브타입 테이블로 변환(구현 클래스마다 테이블 전략)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#매핑-정보만-상속mappedsuperclass"><span class="nav-number">2.</span> <span class="nav-text"> 매핑 정보만 상속(@MappedSuperClass)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#복합키-매핑"><span class="nav-number">3.</span> <span class="nav-text"> 복합키 매핑</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#idclass"><span class="nav-number">3.1.</span> <span class="nav-text"> @IdClass</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#embededid"><span class="nav-number">3.2.</span> <span class="nav-text"> @EmbededId</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#복합키의-equals-hashcode"><span class="nav-number">3.3.</span> <span class="nav-text"> 복합키의 equals, hashCode</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#식별비식별-관계에서-복합키-사용"><span class="nav-number">4.</span> <span class="nav-text"> 식별/비식별 관계에서 복합키 사용</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#식별-관계와-비식별-관계"><span class="nav-number">4.1.</span> <span class="nav-text"> 식별 관계와 비식별 관계</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#식별관계"><span class="nav-number">4.1.1.</span> <span class="nav-text"> 식별관계</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#비식별-관계"><span class="nav-number">4.1.2.</span> <span class="nav-text"> 비식별 관계</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#식별-관계-매핑"><span class="nav-number">4.2.</span> <span class="nav-text"> 식별 관계 매핑</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#idclass-2"><span class="nav-number">4.2.1.</span> <span class="nav-text"> @IdClass</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#embeddedid"><span class="nav-number">4.2.2.</span> <span class="nav-text"> @EmbeddedId</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#일대일-식별-관계featmapsid"><span class="nav-number">4.2.3.</span> <span class="nav-text"> 일대일 식별 관계(feat.@MapsId)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#비식별-관계-매핑"><span class="nav-number">4.3.</span> <span class="nav-text"> 비식별 관계 매핑</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#그래서-식별이냐-비식별이냐"><span class="nav-number">4.4.</span> <span class="nav-text"> 그래서 식별이냐 비식별이냐?</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#조인-테이블"><span class="nav-number">5.</span> <span class="nav-text"> 조인 테이블</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#일대일-조인테이블"><span class="nav-number">5.1.</span> <span class="nav-text"> 일대일 조인테이블</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#다대일-조인테이블"><span class="nav-number">5.2.</span> <span class="nav-text"> 다대일 조인테이블</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#일대다-조인테이블"><span class="nav-number">5.3.</span> <span class="nav-text"> 일대다 조인테이블</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#다대다-조인테이블"><span class="nav-number">5.4.</span> <span class="nav-text"> 다대다 조인테이블</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#엔티티-하나에-여러-테이블-매핑"><span class="nav-number">6.</span> <span class="nav-text"> 엔티티 하나에 여러 테이블 매핑</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">JunYoung Park</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> v3.6.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a> v7.1.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.0"></script>

  <script src="/js/motion.js?v=7.1.0"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.1.0"></script>



  
  <script src="/js/scrollspy.js?v=7.1.0"></script>
<script src="/js/post-details.js?v=7.1.0"></script>



  


  <script src="/js/next-boot.js?v=7.1.0"></script>


  

  

  

  
  
  <script id="dsq-count-scr" src="https://joont92.disqus.com/count.js" async></script>


<script>
  var disqus_config = function() {
    this.page.url = "https://joont92.github.io/jpa/고급-매핑/";
    this.page.identifier = "jpa/고급-매핑/";
    this.page.title = '[jpa] 고급 매핑';
    };
  function loadComments() {
    var d = document, s = d.createElement('script');
    s.src = 'https://joont92.disqus.com/embed.js';
    s.setAttribute('data-timestamp', '' + +new Date());
    (d.head || d.body).appendChild(s);
  }
  
    loadComments();
  
</script>





  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
